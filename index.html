<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ú—É–∑—ã–∫–∞–ª—å–Ω–æ–µ –õ–æ—Ç–æ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
  <!-- PWA –º–µ—Ç–∞-—Ç–µ–≥–∏ -->
  <meta name="theme-color" content="#ff4d6d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="–ú—É–∑–õ–æ—Ç–æ">
  <link rel="manifest" href="/muzloto2/manifest.json">
  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/muzloto2/sw.js');
  }
  </script>
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  
  <style>
    :root {
      --bg: #fdfcfb;
      --card: #ffffff;
      --border: #d1d5db;
      --text: #222;
      --primary: #ff4d6d;
      --accent: #ffd166;
      --success: #4caf50;
      --danger: #f44336;
    }

    * {
      -webkit-tap-highlight-color: transparent;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #fdfcfb, #e2d1c3);
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      min-height: 100vh;
      overflow-x: hidden;
      touch-action: manipulation;
    }

    .hidden { display: none !important; }

    h1 {
      margin: 0;
      font-size: 24px;
      text-align: center;
      padding: 20px 16px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      color: #fff;
      width: 100%;
      box-shadow: 0 4px 12px rgba(255, 77, 109, 0.3);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    h2 {
      margin: 20px 0 15px;
      color: var(--primary);
      font-size: 22px;
    }

    h3 {
      margin: 15px 0 10px;
      color: #555;
      font-size: 18px;
    }

    .section {
      width: 95%;
      max-width: 600px;
      margin: 0 auto;
      padding: 0 10px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin: 15px 0;
      width: 100%;
    }

    .btn {
      flex: 1;
      min-width: 140px;
      min-height: 50px;
      margin: 5px;
      padding: 14px 20px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      background: var(--primary);
      color: #fff;
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
      transition: all 0.2s ease;
      touch-action: manipulation;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }
    
    .btn:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .btn.secondary { 
      background: var(--accent); 
      color: #222; 
    }
    
    .btn.success { 
      background: var(--success); 
      color: white; 
    }
    
    .btn.danger { 
      background: var(--danger); 
      color: white; 
    }
    
    .btn.system {
      background: #e0e0e0;
      color: #222;
      font-size: 14px;
      padding: 12px 16px;
      min-width: 130px;
      min-height: 44px;
    }

    /* –°–≤–æ—Ä–∞—á–∏–≤–∞—é—â–∏–π—Å—è –±–ª–æ–∫ */
    .collapsible {
      width: 100%;
      max-width: 500px;
      margin: 15px auto;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .collapsible-header {
      background: linear-gradient(90deg, var(--primary), #ff7b9d);
      color: white;
      padding: 14px 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      user-select: none;
    }

    .collapsible-content {
      background: white;
      padding: 20px;
      max-height: 500px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ */
    .file-input-wrapper {
      width: 100%;
      margin: 15px 0;
    }

    #fileInput {
      width: 100%;
      padding: 15px;
      border: 2px dashed var(--primary);
      border-radius: 10px;
      background: rgba(255, 77, 109, 0.05);
      font-size: 16px;
      cursor: pointer;
    }

    /* –°–ø–∏—Å–æ–∫ –ø–µ—Å–µ–Ω */
    #songsOutput {
      width: 100%;
      max-width: 500px;
      padding: 15px;
      margin: 10px auto;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      line-height: 1.6;
      font-family: "Courier New", monospace;
      min-height: 150px;
      resize: none;
      background: #fff;
      box-shadow: inset 0 2px 6px rgba(0,0,0,0.05);
      -webkit-overflow-scrolling: touch;
    }

    /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º */
    .play-controls {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      margin: 20px auto;
      width: 95%;
      max-width: 500px;
    }

    .number-input {
      width: 80px;
      height: 50px;
      padding: 10px;
      font-size: 20px;
      text-align: center;
      border: 2px solid var(--primary);
      border-radius: 10px;
      margin: 0 10px;
      font-weight: bold;
    }

    .current-song {
      font-size: 18px;
      font-weight: 600;
      color: var(--primary);
      margin: 15px 0;
      padding: 12px;
      background: #fff9e6;
      border-radius: 10px;
      border-left: 5px solid var(--accent);
    }

    audio {
      width: 100%;
      margin: 20px 0;
      border-radius: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* –ë–∏–ª–µ—Ç 5√ó3 */
    .grid.ticket {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(3, 90px);
      gap: 8px;
      justify-items: center;
      align-items: center;
      margin: 20px auto;
      padding: 15px;
      width: 100%;
      max-width: 500px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }

    .cell {
      background: var(--card);
      border: 3px solid var(--primary);
      border-radius: 10px;
      width: 100%;
      height: 100%;
      padding: 8px 4px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      word-wrap: break-word;
      overflow-wrap: break-word;
      text-overflow: ellipsis;
      overflow: hidden;
      transition: all 0.3s ease;
      user-select: none;
    }
    
    .cell:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .cell:active {
      transform: scale(0.95);
    }
    
    .cell.long-text { font-size: 12px; }
    .cell.crossed { 
      background: linear-gradient(135deg, var(--accent), #ffde8a); 
      text-decoration: line-through;
      border-color: #ffb300;
      color: #5d4037;
    }

    /* –ë–æ—á–æ–Ω–∫–∏ */
    #playedBarrels {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin: 20px 0;
      padding: 15px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
      min-height: 70px;
    }

    .barrel {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), #ffb347);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 20px;
      color: #222;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      animation: pop 0.3s ease;
      user-select: none;
    }

    @keyframes pop {
      0% { transform: scale(0); }
      70% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
    .center-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin: 25px 0;
      width: 100%;
    }

    /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--success);
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
      z-index: 1000;
      animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
      max-width: 300px;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 600px) {
      h1 { font-size: 22px; padding: 18px 12px; }
      h2 { font-size: 20px; margin: 15px 0 10px; }
      h3 { font-size: 17px; margin: 12px 0 8px; }
      
      .btn { 
        font-size: 15px; 
        padding: 12px 16px; 
        min-width: 120px;
        min-height: 46px;
      }
      
      .cell { 
        font-size: 13px; 
        padding: 6px 3px;
      }
      
      .cell.long-text { font-size: 11px; }
      
      .grid.ticket { 
        grid-template-rows: repeat(3, 80px);
        gap: 6px;
        padding: 12px;
      }
      
      .barrel {
        width: 45px;
        height: 45px;
        font-size: 18px;
      }
      
      .number-input {
        width: 70px;
        height: 45px;
        font-size: 18px;
      }
      
      #songsOutput {
        font-size: 15px;
        padding: 12px;
      }
    }

    @media (max-width: 400px) {
      .grid.ticket { 
        grid-template-rows: repeat(3, 70px);
      }
      
      .cell { 
        font-size: 12px; 
      }
      
      .cell.long-text { font-size: 10px; }
      
      .btn { 
        min-width: 100px;
        padding: 10px 14px;
      }
    }

    /* –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ */
    .back-btn {
      position: absolute;
      left: 15px;
      top: 15px;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
      z-index: 101;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
    .stats {
      display: flex;
      justify-content: space-around;
      background: white;
      padding: 15px;
      border-radius: 12px;
      margin: 15px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
    }

    .stat-label {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h1>üéµ –ú—É–∑—ã–∫–∞–ª—å–Ω–æ–µ –õ–æ—Ç–æ</h1>

  <!-- –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏ -->
  <div id="roleSelect" class="section">
    <button id="hostBtn" class="btn">üé§ –Ø –≤–µ–¥—É—â–∏–π</button>
    <button id="playerBtn" class="btn secondary">üéÆ –Ø –∏–≥—Ä–æ–∫</button>
    
    <div class="stats">
      <div class="stat-item">
        <div class="stat-value" id="totalGames">0</div>
        <div class="stat-label">–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="totalSongs">0</div>
        <div class="stat-label">–ü–µ—Å–µ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω–æ</div>
      </div>
    </div>
  </div>

  <!-- –í–µ–¥—É—â–∏–π -->
  <div id="hostSection" class="section hidden">
    <button class="back-btn" onclick="goBack()">‚Üê</button>
    <h2>üé§ –í–µ–¥—É—â–∏–π</h2>

    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ -->
    <div class="collapsible">
      <div class="collapsible-header" onclick="toggleCollapsible('songsInputSection')">
        <span>üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤</span>
        <span id="songsInputArrow">‚ñº</span>
      </div>
      <div id="songsInputSection" class="collapsible-content">
        <div class="file-input-wrapper">
          <input id="fileInput" type="file" accept="audio/*" multiple>
        </div>
        <div class="row">
          <button id="prepareBtn" class="btn system">‚úÖ –°–æ–∑–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫</button>
          <button id="uploadBtn" class="btn system success">‚òÅÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ</button>
        </div>
        <textarea id="songsOutput" readonly placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–µ—Å–µ–Ω..."></textarea>
      </div>
    </div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º -->
    <div class="play-controls">
      <h3>‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ</h3>
      <div class="row">
        <input id="songNumber" type="number" min="1" placeholder="‚Ññ" class="number-input">
        <button id="playBtn" class="btn">üéµ –ò–≥—Ä–∞—Ç—å</button>
        <button id="stopBtn" class="btn danger">‚èπ –°—Ç–æ–ø</button>
      </div>
      
      <div class="current-song">
        <strong>–°–µ–π—á–∞—Å –∏–≥—Ä–∞–µ—Ç:</strong>
        <span id="currentTitle">‚Äî</span>
      </div>
      
      <div class="row">
        <button id="prevBtn" class="btn system">‚óÄ –ü—Ä–µ–¥—ã–¥—É—â–∞—è</button>
        <button id="nextBtn" class="btn system">–°–ª–µ–¥—É—é—â–∞—è ‚ñ∂</button>
      </div>
      
      <audio id="player" controls preload="none"></audio>
    </div>

    <!-- –°—ã–≥—Ä–∞–Ω–Ω—ã–µ –ø–µ—Å–Ω–∏ -->
    <h3>üéØ –°—ã–≥—Ä–∞–Ω–Ω—ã–µ –ø–µ—Å–Ω–∏</h3>
    <div id="playedBarrels"></div>
    
    <div class="row">
      <button id="clearPlayedBtn" class="btn system danger">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
      <button id="autoMarkBtn" class="btn system">üéØ –ê–≤—Ç–æ-–æ—Ç–º–µ—Ç–∫–∞</button>
    </div>

    <!-- –ë–∏–ª–µ—Ç -->
    <div class="center-buttons">
      <button id="hostTicketBtn" class="btn">üé´ –°–æ–∑–¥–∞—Ç—å –±–∏–ª–µ—Ç</button>
      <button id="shareTicketBtn" class="btn success" onclick="shareTicket()">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
    </div>
    <div id="hostTicketGrid" class="grid ticket"></div>
    
    <div class="row">
      <button id="resetTicketBtn" class="btn system danger">üîÑ –ù–æ–≤—ã–π –±–∏–ª–µ—Ç</button>
    </div>
  </div>

  <!-- –ò–≥—Ä–æ–∫ -->
  <div id="playerSection" class="section hidden">
    <button class="back-btn" onclick="goBack()">‚Üê</button>
    <h2>üéÆ –ò–≥—Ä–æ–∫</h2>
    
    <button id="getTicketBtn" class="btn">üé´ –°–æ–∑–¥–∞—Ç—å –±–∏–ª–µ—Ç</button>
    <div id="ticketGrid" class="grid ticket"></div>
    
    <div class="center-buttons">
      <button id="checkWinBtn" class="btn success">üèÜ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–±–µ–¥—É</button>
    </div>
    
    <div id="playerStats" class="stats">
      <div class="stat-item">
        <div class="stat-value" id="markedCount">0</div>
        <div class="stat-label">–û—Ç–º–µ—á–µ–Ω–æ</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="remainingCount">15</div>
        <div class="stat-label">–û—Å—Ç–∞–ª–æ—Å—å</div>
      </div>
    </div>
  </div>

  <div id="notificationArea"></div>

  <script>
    const SERVER_URL = "https://muzloto.vercel.app";
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let files = [];
    let songs = [];
    let playedNumbers = [];
    let ticketCreated = false;
    let currentSongIndex = 0;
    
    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const roleSelectEl = document.getElementById("roleSelect");
    const hostSectionEl = document.getElementById("hostSection");
    const playerSectionEl = document.getElementById("playerSection");
    
    const fileInputEl = document.getElementById("fileInput");
    const prepareBtnEl = document.getElementById("prepareBtn");
    const uploadBtnEl = document.getElementById("uploadBtn");
    const songsOutputEl = document.getElementById("songsOutput");
    
    const songNumberEl = document.getElementById("songNumber");
    const playBtnEl = document.getElementById("playBtn");
    const stopBtnEl = document.getElementById("stopBtn");
    const prevBtnEl = document.getElementById("prevBtn");
    const nextBtnEl = document.getElementById("nextBtn");
    const playerEl = document.getElementById("player");
    const currentTitleEl = document.getElementById("currentTitle");
    
    const playedBarrelsEl = document.getElementById("playedBarrels");
    const clearPlayedBtnEl = document.getElementById("clearPlayedBtn");
    
    const hostTicketBtnEl = document.getElementById("hostTicketBtn");
    const hostTicketGridEl = document.getElementById("hostTicketGrid");
    const resetTicketBtnEl = document.getElementById("resetTicketBtn");
    const autoMarkBtnEl = document.getElementById("autoMarkBtn");
    
    const getTicketBtnEl = document.getElementById("getTicketBtn");
    const ticketGridEl = document.getElementById("ticketGrid");
    const checkWinBtnEl = document.getElementById("checkWinBtn");
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', () => {
      initializeApp();
      updateStats();
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    function initializeApp() {
      // –í—ã–±–æ—Ä —Ä–æ–ª–∏
      document.getElementById("hostBtn").addEventListener("click", () => {
        roleSelectEl.classList.add("hidden");
        hostSectionEl.classList.remove("hidden");
        vibrate(50);
      });
      
      document.getElementById("playerBtn").addEventListener("click", () => {
        roleSelectEl.classList.add("hidden");
        playerSectionEl.classList.remove("hidden");
        vibrate(50);
      });
      
      // –í–µ–¥—É—â–∏–π: –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏–∑ —Ñ–∞–π–ª–æ–≤
      prepareBtnEl.addEventListener("click", () => {
        files = Array.from(fileInputEl.files || []);
        if (!files.length) {
          showNotification("–í—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã.", "warning");
          return;
        }
        songs = files.map((f, i) => `${i + 1}. ${stripExt(f.name)}`);
        songsOutputEl.value = songs.join("\n");
        updateStats();
        showNotification(`–°–ø–∏—Å–æ–∫ –∏–∑ ${songs.length} –ø–µ—Å–µ–Ω —Å–æ–∑–¥–∞–Ω`, "success");
        vibrate(100);
      });
      
      // –í–µ–¥—É—â–∏–π: –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      uploadBtnEl.addEventListener("click", async () => {
        if (!songs.length) {
          showNotification("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Å–ø–∏—Å–æ–∫", "warning");
          return;
        }
        
        showNotification("–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...", "info");
        try {
          const res = await fetch(`${SERVER_URL}/api/songs`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(songs)
          });
          
          if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
          
          showNotification("–°–ø–∏—Å–æ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä!", "success");
          vibrate(200);
        } catch (e) {
          console.error(e);
          showNotification("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫", "error");
        }
      });
      
      // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
      playBtnEl.addEventListener("click", () => {
        if (!files.length) {
          showNotification("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã", "warning");
          return;
        }
        const num = parseInt(songNumberEl.value, 10);
        
        if (!Number.isInteger(num) || num < 1 || num > files.length) {
          showNotification("–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –ø–µ—Å–Ω–∏", "warning");
          return;
        }
        
        if (playedNumbers.includes(num)) {
          showNotification("–≠—Ç–∞ –ø–µ—Å–Ω—è —É–∂–µ –ø—Ä–æ–∏–≥—Ä–∞–Ω–∞", "info");
          return;
        }
        
        currentSongIndex = num - 1;
        playCurrentSong();
      });
      
      stopBtnEl.addEventListener("click", () => {
        playerEl.pause();
        playerEl.currentTime = 0;
        showNotification("–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ", "info");
      });
      
      prevBtnEl.addEventListener("click", () => {
        if (currentSongIndex > 0) {
          currentSongIndex--;
          songNumberEl.value = currentSongIndex + 1;
          playCurrentSong();
        }
      });
      
      nextBtnEl.addEventListener("click", () => {
        if (currentSongIndex < files.length - 1) {
          currentSongIndex++;
          songNumberEl.value = currentSongIndex + 1;
          playCurrentSong();
        }
      });
      
      // –û—á–∏—Å—Ç–∫–∞ —Å—ã–≥—Ä–∞–Ω–Ω—ã—Ö
      clearPlayedBtnEl.addEventListener("click", () => {
        if (confirm("–û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å—ã–≥—Ä–∞–Ω–Ω—ã—Ö –ø–µ—Å–µ–Ω?")) {
          playedNumbers = [];
          renderPlayedBarrels();
          showNotification("–°–ø–∏—Å–æ–∫ –æ—á–∏—â–µ–Ω", "info");
        }
      });
      
      // –í–µ–¥—É—â–∏–π: —Å–æ–∑–¥–∞—Ç—å –±–∏–ª–µ—Ç
      hostTicketBtnEl.addEventListener("click", async () => {
        if (ticketCreated) {
          showNotification("–ë–∏–ª–µ—Ç —É–∂–µ —Å–æ–∑–¥–∞–Ω", "info");
          return;
        }
        
        const list = await fetchSongsFromServer();
        if (!list.length && songs.length) {
          list.push(...songs);
        }
        
        if (!list.length) {
          showNotification("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –ø–µ—Å–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä", "warning");
          return;
        }
        
        const unique = Array.from(new Set(list));
        const selected = shuffle(unique).slice(0, 15);
        renderTicket(selected, hostTicketGridEl);
        ticketCreated = true;
        updateStats();
        showNotification("–ë–∏–ª–µ—Ç —Å–æ–∑–¥–∞–Ω!", "success");
        vibrate(150);
      });
      
      resetTicketBtnEl.addEventListener("click", () => {
        ticketCreated = false;
        hostTicketGridEl.innerHTML = "";
        showNotification("–ë–∏–ª–µ—Ç —Å–±—Ä–æ—à–µ–Ω", "info");
      });
      
      autoMarkBtnEl.addEventListener("click", () => {
        const cells = hostTicketGridEl.querySelectorAll('.cell');
        cells.forEach(cell => {
          if (playedNumbers.some(num => cell.textContent.includes(num + '.'))) {
            cell.classList.add('crossed');
          }
        });
        showNotification("–ê–≤—Ç–æ-–æ—Ç–º–µ—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞", "success");
      });
      
      // –ò–≥—Ä–æ–∫: —Å–æ–∑–¥–∞—Ç—å –±–∏–ª–µ—Ç
      getTicketBtnEl.addEventListener("click", async () => {
        if (ticketCreated) {
          showNotification("–ë–∏–ª–µ—Ç —É–∂–µ —Å–æ–∑–¥–∞–Ω", "info");
          return;
        }
        
        const list = await fetchSongsFromServer();
        if (!list.length) {
          showNotification("–í–µ–¥—É—â–∏–π –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª —Å–ø–∏—Å–æ–∫", "warning");
          return;
        }
        
        const unique = Array.from(new Set(list));
        const selected = shuffle(unique).slice(0, 15);
        renderTicket(selected, ticketGridEl, true);
        ticketCreated = true;
        showNotification("–í–∞—à –±–∏–ª–µ—Ç –≥–æ—Ç–æ–≤!", "success");
        vibrate(150);
      });
      
      checkWinBtnEl.addEventListener("click", () => {
        const crossed = ticketGridEl.querySelectorAll('.cell.crossed').length;
        if (crossed === 15) {
          showNotification("üéâ –ë–ò–ù–ì–û! –í—ã –ø–æ–±–µ–¥–∏–ª–∏!", "success");
          vibrate([100, 100, 100]);
        } else {
          showNotification(`–û—Ç–º–µ—á–µ–Ω–æ ${crossed} –∏–∑ 15 —è—á–µ–µ–∫`, "info");
        }
      });
    }
    
    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —Ç–µ–∫—É—â—É—é –ø–µ—Å–Ω—é
    function playCurrentSong() {
      const num = currentSongIndex + 1;
      const file = files[currentSongIndex];
      
      if (!file) {
        showNotification("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω", "error");
        return;
      }
      
      const title = `${num}. ${stripExt(file.name)}`;
      currentTitleEl.textContent = title;
      
      playerEl.src = URL.createObjectURL(file);
      playerEl.play();
      
      if (!playedNumbers.includes(num)) {
        playedNumbers.push(num);
        playedNumbers.sort((a, b) => a - b);
        renderPlayedBarrels();
        showNotification(`–ò–≥—Ä–∞–µ—Ç: ${title}`, "success");
        vibrate(100);
      }
      
      updatePlayerStats();
    }
    
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function stripExt(name) {
      return name.replace(/\.[^/.]+$/, "");
    }
    
    async function fetchSongsFromServer() {
      try {
        const res = await fetch(`${SERVER_URL}/api/songs`);
        if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è");
        const json = await res.json();
        return Array.isArray(json) ? json : [];
      } catch (e) {
        console.error(e);
        showNotification("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å —Å–µ—Ä–≤–µ—Ä–∞", "error");
        return [];
      }
    }
    
    function shuffle(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }
    
    function renderPlayedBarrels() {
      playedBarrelsEl.innerHTML = "";
      playedNumbers.forEach(n => {
        playedBarrelsEl.appendChild(makeBarrel(n));
      });
      updatePlayerStats();
    }
    
    function makeBarrel(num) {
      const barrel = document.createElement("div");
      barrel.className = "barrel";
      barrel.textContent = num;
      barrel.addEventListener('click', () => {
        songNumberEl.value = num;
        playCurrentSong();
      });
      return barrel;
    }
    
    function renderTicket(names, gridEl, isPlayer = false) {
      gridEl.innerHTML = "";
      names.forEach((name, index) => {
        const cell = document.createElement("div");
        cell.className = "cell";
        cell.textContent = name;
        cell.title = name;
        cell.dataset.index = index;
        
        if (name.length > 30) {
          cell.classList.add("long-text");
        }
        
        cell.addEventListener("click", () => {
          cell.classList.toggle("crossed");
          if (isPlayer) updatePlayerStats();
          vibrate(30);
        });
        
        gridEl.appendChild(cell);
      });
      
      if (isPlayer) updatePlayerStats();
    }
    
    function updatePlayerStats() {
      if (ticketGridEl) {
        const crossed = ticketGridEl.querySelectorAll('.cell.crossed').length;
        const remaining = 15 - crossed;
        
        document.getElementById('markedCount').textContent = crossed;
        document.getElementById('remainingCount').textContent = remaining;
      }
    }
    
    function updateStats() {
      document.getElementById('totalSongs').textContent = songs.length;
      document.getElementById('totalGames').textContent = ticketCreated ? 1 : 0;
    }
    
    function goBack() {
      hostSectionEl.classList.add("hidden");
      playerSectionEl.classList.add("hidden");
      roleSelectEl.classList.remove("hidden");
      vibrate(50);
    }
    
    function toggleCollapsible(id) {
      const element = document.getElementById(id);
      const arrow = document.getElementById(id.replace('Section', 'Arrow'));
      
      element.classList.toggle('hidden');
      arrow.textContent = element.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
    }
    
    function showNotification(message, type = "info") {
      const notification = document.createElement("div");
      notification.className = `notification ${type}`;
      notification.textContent = message;
      
      const area = document.getElementById("notificationArea");
      area.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }
    
    function vibrate(pattern) {
      if (navigator.vibrate) {
        navigator.vibrate(pattern);
      }
    }
    
    function shareTicket() {
      if (navigator.share) {
        navigator.share({
          title: '–ú–æ–π –±–∏–ª–µ—Ç –ú—É–∑—ã–∫–∞–ª—å–Ω–æ–≥–æ –õ–æ—Ç–æ',
          text: '–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –º–æ–π –±–∏–ª–µ—Ç –¥–ª—è –∏–≥—Ä—ã –≤ –ú—É–∑—ã–∫–∞–ª—å–Ω–æ–µ –õ–æ—Ç–æ!',
          url: window.location.href
        });
      } else {
        alert('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É: ' + window.location.href);
      }
    }
  </script>
</body>

</html>
