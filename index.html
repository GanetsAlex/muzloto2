<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ú—É–∑—ã–∫–∞–ª—å–Ω–æ–µ –õ–æ—Ç–æ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
  <!-- PWA –º–µ—Ç–∞-—Ç–µ–≥–∏ -->
  <meta name="theme-color" content="#ff4d6d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="–ú—É–∑–õ–æ—Ç–æ">
  <link rel="manifest" href="/muzloto2/manifest.json">
  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/muzloto2/sw.js');
  }
  </script>
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  
  <style>
    :root {
      --bg: #fdfcfb;
      --card: #ffffff;
      --border: #d1d5db;
      --text: #222;
      --primary: #ff4d6d;
      --accent: #ffd166;
      --success: #4caf50;
      --danger: #f44336;
      --info: #2196f3;
    }

    * {
      -webkit-tap-highlight-color: transparent;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #fdfcfb, #e2d1c3);
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      min-height: 100vh;
      overflow-x: hidden;
      touch-action: manipulation;
    }

    .hidden { display: none !important; }

    h1 {
      margin: 0;
      font-size: 24px;
      text-align: center;
      padding: 20px 16px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      color: #fff;
      width: 100%;
      box-shadow: 0 4px 12px rgba(255, 77, 109, 0.3);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    h2 {
      margin: 20px 0 15px;
      color: var(--primary);
      font-size: 22px;
    }

    h3 {
      margin: 15px 0 10px;
      color: #555;
      font-size: 18px;
    }

    .section {
      width: 95%;
      max-width: 600px;
      margin: 0 auto;
      padding: 0 10px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin: 15px 0;
      width: 100%;
    }

    .btn {
      flex: 1;
      min-width: 140px;
      min-height: 50px;
      margin: 5px;
      padding: 14px 20px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      background: var(--primary);
      color: #fff;
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
      transition: all 0.2s ease;
      touch-action: manipulation;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }
    
    .btn:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .btn.secondary { 
      background: var(--accent); 
      color: #222; 
    }
    
    .btn.success { 
      background: var(--success); 
      color: white; 
    }
    
    .btn.danger { 
      background: var(--danger); 
      color: white; 
    }
    
    .btn.info { 
      background: var(--info); 
      color: white; 
    }
    
    .btn.system {
      background: #e0e0e0;
      color: #222;
      font-size: 14px;
      padding: 12px 16px;
      min-width: 130px;
      min-height: 44px;
    }

    /* –°–≤–æ—Ä–∞—á–∏–≤–∞—é—â–∏–π—Å—è –±–ª–æ–∫ */
    .collapsible {
      width: 100%;
      max-width: 500px;
      margin: 15px auto;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .collapsible-header {
      background: linear-gradient(90deg, var(--primary), #ff7b9d);
      color: white;
      padding: 14px 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      user-select: none;
    }

    .collapsible-content {
      background: white;
      padding: 20px;
      max-height: 500px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ */
    .file-input-wrapper {
      width: 100%;
      margin: 15px 0;
    }

    #fileInput {
      width: 100%;
      padding: 15px;
      border: 2px dashed var(--primary);
      border-radius: 10px;
      background: rgba(255, 77, 109, 0.05);
      font-size: 16px;
      cursor: pointer;
    }

    /* –°–ø–∏—Å–æ–∫ –ø–µ—Å–µ–Ω */
    #songsOutput {
      width: 100%;
      max-width: 500px;
      padding: 15px;
      margin: 10px auto;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 15px;
      line-height: 1.6;
      font-family: "Courier New", monospace;
      min-height: 150px;
      resize: none;
      background: #fff;
      box-shadow: inset 0 2px 6px rgba(0,0,0,0.05);
      -webkit-overflow-scrolling: touch;
    }

    /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º */
    .play-controls {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      margin: 20px auto;
      width: 95%;
      max-width: 500px;
    }

    .number-input {
      width: 80px;
      height: 50px;
      padding: 10px;
      font-size: 20px;
      text-align: center;
      border: 2px solid var(--primary);
      border-radius: 10px;
      margin: 0 10px;
      font-weight: bold;
    }

    .text-input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 16px;
      margin: 10px 0;
    }

    .current-song {
      font-size: 18px;
      font-weight: 600;
      color: var(--primary);
      margin: 15px 0;
      padding: 12px;
      background: #fff9e6;
      border-radius: 10px;
      border-left: 5px solid var(--accent);
    }

    audio {
      width: 100%;
      margin: 20px 0;
      border-radius: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* –ë–∏–ª–µ—Ç 5√ó3 */
    .grid.ticket {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(3, 90px);
      gap: 8px;
      justify-items: center;
      align-items: center;
      margin: 20px auto;
      padding: 15px;
      width: 100%;
      max-width: 500px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }

    .cell {
      background: var(--card);
      border: 3px solid var(--primary);
      border-radius: 10px;
      width: 100%;
      height: 100%;
      padding: 8px 4px;
      text-align: center;
      font-size: clamp(10px, 2vw, 14px);
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      word-wrap: break-word;
      overflow-wrap: break-word;
      text-overflow: ellipsis;
      overflow: hidden;
      transition: all 0.3s ease;
      user-select: none;
      line-height: 1.2;
      hyphens: auto;
    }
    
    .cell:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .cell:active {
      transform: scale(0.95);
    }
    
    .cell.long-text { 
      font-size: clamp(8px, 1.8vw, 12px); 
    }
    .cell.crossed { 
      background: linear-gradient(135deg, var(--accent), #ffde8a); 
      text-decoration: line-through;
      border-color: #ffb300;
      color: #5d4037;
    }

    /* –ë–æ—á–æ–Ω–∫–∏ */
    #playedBarrels {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin: 20px 0;
      padding: 15px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
      min-height: 70px;
    }

    .barrel {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), #ffb347);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 20px;
      color: #222;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      animation: pop 0.3s ease;
      user-select: none;
      cursor: pointer;
    }

    @keyframes pop {
      0% { transform: scale(0); }
      70% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
    .center-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin: 25px 0;
      width: 100%;
    }

    /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--success);
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
      z-index: 1000;
      animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
      max-width: 300px;
    }

    .notification.warning { background: #ff9800; }
    .notification.error { background: var(--danger); }
    .notification.info { background: var(--info); }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 600px) {
      h1 { font-size: 22px; padding: 18px 12px; }
      h2 { font-size: 20px; margin: 15px 0 10px; }
      h3 { font-size: 17px; margin: 12px 0 8px; }
      
      .btn { 
        font-size: 15px; 
        padding: 12px 16px; 
        min-width: 120px;
        min-height: 46px;
      }
      
      .cell { 
        font-size: clamp(9px, 1.8vw, 13px); 
        padding: 6px 3px;
      }
      
      .cell.long-text { font-size: clamp(7px, 1.5vw, 11px); }
      
      .grid.ticket { 
        grid-template-rows: repeat(3, 80px);
        gap: 6px;
        padding: 12px;
      }
      
      .barrel {
        width: 45px;
        height: 45px;
        font-size: 18px;
      }
      
      .number-input {
        width: 70px;
        height: 45px;
        font-size: 18px;
      }
      
      #songsOutput {
        font-size: 15px;
        padding: 12px;
      }
    }

    @media (max-width: 400px) {
      .grid.ticket { 
        grid-template-rows: repeat(3, 70px);
      }
      
      .cell { 
        font-size: clamp(8px, 1.5vw, 12px); 
      }
      
      .cell.long-text { font-size: clamp(6px, 1.2vw, 10px); }
      
      .btn { 
        min-width: 100px;
        padding: 10px 14px;
      }
    }

    /* –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ */
    .back-btn {
      position: absolute;
      left: 15px;
      top: 15px;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
      z-index: 101;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
    .stats {
      display: flex;
      justify-content: space-around;
      background: white;
      padding: 15px;
      border-radius: 12px;
      margin: 15px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
    }

    .stat-label {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }

    /* –ö–æ–º–Ω–∞—Ç–∞ */
    .room-info {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      margin: 20px auto;
      width: 95%;
      max-width: 500px;
    }

    .room-code {
      font-family: monospace;
      font-size: 32px;
      font-weight: bold;
      letter-spacing: 3px;
      color: var(--primary);
      background: #f0f0f0;
      padding: 10px 20px;
      border-radius: 10px;
      margin: 15px 0;
      display: inline-block;
    }

    .players-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin: 15px 0;
    }

    .player-badge {
      background: linear-gradient(135deg, var(--accent), #ffb347);
      color: #222;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
    }

    .player-badge.host {
      background: linear-gradient(135deg, var(--primary), #ff7b9d);
      color: white;
    }
  </style>
</head>
<body>
  <h1>üéµ –ú—É–∑—ã–∫–∞–ª—å–Ω–æ–µ –õ–æ—Ç–æ</h1>

  <!-- –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏ -->
  <div id="roleSelect" class="section">
    <button id="hostBtn" class="btn">üé§ –Ø –≤–µ–¥—É—â–∏–π</button>
    <button id="playerBtn" class="btn secondary">üéÆ –Ø –∏–≥—Ä–æ–∫</button>
    
    <div class="stats">
      <div class="stat-item">
        <div class="stat-value" id="totalGames">0</div>
        <div class="stat-label">–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="totalSongs">0</div>
        <div class="stat-label">–ü–µ—Å–µ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω–æ</div>
      </div>
    </div>
    
    <div style="margin-top: 20px;">
      <a href="https://muzloto.vercel.app/admin.html" target="_blank" class="btn system">üõ† –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</a>
      <p style="font-size: 12px; color: #666; margin-top: 5px;">
      </p>
    </div>
  </div>

  <!-- –≠–∫—Ä–∞–Ω –∫–æ–º–Ω–∞—Ç—ã (–ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏) -->
  <div id="roomSection" class="section hidden">
    <button class="back-btn" onclick="goBackToRoleSelect()">‚Üê</button>
    <h2>üé™ –ö–æ–º–Ω–∞—Ç–∞ –∏–≥—Ä—ã</h2>
    
    <div id="roomActions" class="room-info">
      <!-- –î–ª—è –≤–µ–¥—É—â–µ–≥–æ -->
      <div id="hostRoomSection" class="hidden">
        <h3>‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É</h3>
        <input type="text" id="hostNameInput" placeholder="–í–∞—à–µ –∏–º—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" class="text-input">
        <div class="row">
          <button id="createRoomBtn" class="btn">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
        </div>
      </div>
      
      <!-- –î–ª—è –∏–≥—Ä–æ–∫–∞ -->
      <div id="playerRoomSection" class="hidden">
        <h3>üîó –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ</h3>
        <input type="text" id="playerNameInput" placeholder="–í–∞—à–µ –∏–º—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" class="text-input">
        <input type="text" id="roomCodeInput" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: ABC123)" class="text-input">
        <div class="row">
          <button id="joinRoomBtn" class="btn secondary">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
        </div>
      </div>
    </div>
    
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–π –∫–æ–º–Ω–∞—Ç–µ -->
    <div id="currentRoomInfo" class="room-info hidden">
      <h3>–¢–µ–∫—É—â–∞—è –∫–æ–º–Ω–∞—Ç–∞</h3>
      <div class="room-code" id="roomCodeDisplay">---</div>
      
      <div class="stats">
        <div class="stat-item">
          <div class="stat-value" id="songsCountDisplay">0</div>
          <div class="stat-label">–ü–µ—Å–µ–Ω</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="playedCountDisplay">0</div>
          <div class="stat-label">–°—ã–≥—Ä–∞–Ω–æ</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="playersCountDisplay">1</div>
          <div class="stat-label">–ò–≥—Ä–æ–∫–æ–≤</div>
        </div>
      </div>
      
      <h4>–ò–≥—Ä–æ–∫–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ:</h4>
      <div id="playersList" class="players-list">
        <div class="player-badge host">üëë –í–µ–¥—É—â–∏–π</div>
      </div>
      
      <div class="row" style="margin-top: 20px;">
        <button id="copyRoomCodeBtn" class="btn system">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
        <button id="startGameBtn" class="btn success" onclick="startGame()">‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
        <button id="leaveRoomBtn" class="btn system danger">üö™ –í—ã–π—Ç–∏</button>
      </div>
    </div>
  </div>

  <!-- –í–µ–¥—É—â–∏–π -->
  <div id="hostSection" class="section hidden">
    <button class="back-btn" onclick="goBackToRoom()">‚Üê</button>
    <h2>üé§ <span id="hostTitle">–í–µ–¥—É—â–∏–π</span> <small>(–∫–æ–º–Ω–∞—Ç–∞: <span id="hostRoomCode">---</span>)</small></h2>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–Ω–∞—Ç–µ -->
    <div class="room-info">
      <div class="stats">
        <div class="stat-item">
          <div class="stat-value" id="hostSongsCount">0</div>
          <div class="stat-label">–ü–µ—Å–µ–Ω</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="hostPlayersCount">1</div>
          <div class="stat-label">–ò–≥—Ä–æ–∫–æ–≤</div>
        </div>
        <div class="stat-item">
          <button id="syncRoomBtn" class="btn system" onclick="syncRoomData()">üîÑ –°–∏–Ω—Ö—Ä.</button>
          <div class="stat-label">–ö–æ–º–Ω–∞—Ç–∞</div>
        </div>
      </div>
    </div>

    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ -->
    <div class="collapsible">
      <div class="collapsible-header" onclick="toggleCollapsible('songsInputSection')">
        <span>üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤</span>
        <span id="songsInputArrow">‚ñº</span>
      </div>
      <div id="songsInputSection" class="collapsible-content">
        <div class="file-input-wrapper">
          <input id="fileInput" type="file" accept="audio/*" multiple>
        </div>
        <div class="row">
          <button id="prepareBtn" class="btn system">‚úÖ –°–æ–∑–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫</button>
          <button id="uploadBtn" class="btn system success">‚òÅÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –∫–æ–º–Ω–∞—Ç—É</button>
        </div>
        <textarea id="songsOutput" readonly placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–µ—Å–µ–Ω..."></textarea>
      </div>
    </div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º -->
    <div class="play-controls">
      <h3>‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ</h3>
      <div class="row">
        <input id="songNumber" type="number" min="1" placeholder="‚Ññ" class="number-input">
        <button id="playBtn" class="btn">üéµ –ò–≥—Ä–∞—Ç—å</button>
      </div>
      
      <div class="current-song">
        <strong>–°–µ–π—á–∞—Å –∏–≥—Ä–∞–µ—Ç:</strong>
        <span id="currentTitle">‚Äî</span>
      </div>
      
      <audio id="player" controls preload="none"></audio>
    </div>

    <!-- –°—ã–≥—Ä–∞–Ω–Ω—ã–µ –ø–µ—Å–Ω–∏ -->
    <h3>üéØ –°—ã–≥—Ä–∞–Ω–Ω—ã–µ –ø–µ—Å–Ω–∏</h3>
    <div id="playedBarrels"></div>
    
    <div class="row">
      <button id="clearPlayedBtn" class="btn system danger">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <!-- –ë–∏–ª–µ—Ç -->
    <div class="center-buttons">
      <button id="hostTicketBtn" class="btn">üé´ –°–æ–∑–¥–∞—Ç—å –±–∏–ª–µ—Ç</button>
      <button id="shareTicketBtn" class="btn success" onclick="shareTicket()">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
    </div>
    <div id="hostTicketGrid" class="grid ticket"></div>
    
    <div class="row">
      <button id="resetTicketBtn" class="btn system danger">üîÑ –ù–æ–≤—ã–π –±–∏–ª–µ—Ç</button>
    </div>
  </div>

  <!-- –ò–≥—Ä–æ–∫ -->
  <div id="playerSection" class="section hidden">
    <button class="back-btn" onclick="goBackToRoom()">‚Üê</button>
    <h2>üéÆ <span id="playerTitle">–ò–≥—Ä–æ–∫</span> <small>(–∫–æ–º–Ω–∞—Ç–∞: <span id="playerRoomCode">---</span>)</small></h2>
    
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–Ω–∞—Ç–µ -->
    <div class="room-info">
      <div class="stats">
        <div class="stat-item">
          <div class="stat-value" id="playerSongsCount">0</div>
          <div class="stat-label">–ü–µ—Å–µ–Ω</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="playerPlayedCount">0</div>
          <div class="stat-label">–°—ã–≥—Ä–∞–Ω–æ</div>
        </div>
      </div>
    </div>
    
    <button id="getTicketBtn" class="btn">üé´ –°–æ–∑–¥–∞—Ç—å –±–∏–ª–µ—Ç</button>
    <div id="ticketGrid" class="grid ticket"></div>
    
    <div id="playerStats" class="stats">
      <div class="stat-item">
        <div class="stat-value" id="markedCount">0</div>
        <div class="stat-label">–û—Ç–º–µ—á–µ–Ω–æ</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="remainingCount">15</div>
        <div class="stat-label">–û—Å—Ç–∞–ª–æ—Å—å</div>
      </div>
    </div>
  </div>

  <div id="notificationArea"></div>

  <script>
    const SERVER_URL = "https://muzloto.vercel.app";
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let files = [];
    let songs = [];
    let playedNumbers = [];
    let ticketCreated = false;
    let currentSongIndex = 0;
    let currentRoomCode = null;
    let currentRole = null; // 'host' –∏–ª–∏ 'player'
    let isHost = false;
    let roomSyncInterval = null;
    let playerName = '';
    let hostName = '';
    
    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const roleSelectEl = document.getElementById("roleSelect");
    const roomSectionEl = document.getElementById("roomSection");
    const hostSectionEl = document.getElementById("hostSection");
    const playerSectionEl = document.getElementById("playerSection");
    
    const hostRoomSectionEl = document.getElementById("hostRoomSection");
    const playerRoomSectionEl = document.getElementById("playerRoomSection");
    const currentRoomInfoEl = document.getElementById("currentRoomInfo");
    
    const hostNameInputEl = document.getElementById("hostNameInput");
    const playerNameInputEl = document.getElementById("playerNameInput");
    const roomCodeInputEl = document.getElementById("roomCodeInput");
    const createRoomBtnEl = document.getElementById("createRoomBtn");
    const joinRoomBtnEl = document.getElementById("joinRoomBtn");
    
    const roomCodeDisplayEl = document.getElementById("roomCodeDisplay");
    const songsCountDisplayEl = document.getElementById("songsCountDisplay");
    const playedCountDisplayEl = document.getElementById("playedCountDisplay");
    const playersCountDisplayEl = document.getElementById("playersCountDisplay");
    const playersListEl = document.getElementById("playersList");
    const copyRoomCodeBtnEl = document.getElementById("copyRoomCodeBtn");
    const leaveRoomBtnEl = document.getElementById("leaveRoomBtn");
    
    const hostRoomCodeEl = document.getElementById("hostRoomCode");
    const hostSongsCountEl = document.getElementById("hostSongsCount");
    const hostPlayersCountEl = document.getElementById("hostPlayersCount");
    
    const playerRoomCodeEl = document.getElementById("playerRoomCode");
    const playerSongsCountEl = document.getElementById("playerSongsCount");
    const playerPlayedCountEl = document.getElementById("playerPlayedCount");
    
    const fileInputEl = document.getElementById("fileInput");
    const prepareBtnEl = document.getElementById("prepareBtn");
    const uploadBtnEl = document.getElementById("uploadBtn");
    const songsOutputEl = document.getElementById("songsOutput");
    
    const songNumberEl = document.getElementById("songNumber");
    const playBtnEl = document.getElementById("playBtn");
    const playerEl = document.getElementById("player");
    const currentTitleEl = document.getElementById("currentTitle");
    
    const playedBarrelsEl = document.getElementById("playedBarrels");
    const clearPlayedBtnEl = document.getElementById("clearPlayedBtn");
    const autoMarkBtnEl = document.getElementById("autoMarkBtn");
    
    const hostTicketBtnEl = document.getElementById("hostTicketBtn");
    const hostTicketGridEl = document.getElementById("hostTicketGrid");
    const resetTicketBtnEl = document.getElementById("resetTicketBtn");
    
    const getTicketBtnEl = document.getElementById("getTicketBtn");
    const ticketGridEl = document.getElementById("ticketGrid");
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', () => {
      initializeApp();
      updateStats();
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    function initializeApp() {
      // –í—ã–±–æ—Ä —Ä–æ–ª–∏
      document.getElementById("hostBtn").addEventListener("click", () => {
        currentRole = 'host';
        roleSelectEl.classList.add("hidden");
        roomSectionEl.classList.remove("hidden");
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –¥–ª—è –≤–µ–¥—É—â–µ–≥–æ
        hostRoomSectionEl.classList.remove("hidden");
        playerRoomSectionEl.classList.add("hidden");
        vibrate(50);
      });
      
      document.getElementById("playerBtn").addEventListener("click", () => {
        currentRole = 'player';
        roleSelectEl.classList.add("hidden");
        roomSectionEl.classList.remove("hidden");
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –¥–ª—è –∏–≥—Ä–æ–∫–∞
        playerRoomSectionEl.classList.remove("hidden");
        hostRoomSectionEl.classList.add("hidden");
        vibrate(50);
      });
      
      // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
      createRoomBtnEl.addEventListener("click", async () => {
        hostName = hostNameInputEl.value.trim() || '–ê–Ω–æ–Ω–∏–º';
        await createRoom();
      });
      
      // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
      joinRoomBtnEl.addEventListener("click", async () => {
        playerName = playerNameInputEl.value.trim() || '–ê–Ω–æ–Ω–∏–º';
        const roomCode = roomCodeInputEl.value.trim().toUpperCase();
        
        if (!roomCode || roomCode.length !== 6) {
          showNotification("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã (6 —Å–∏–º–≤–æ–ª–æ–≤)", "warning");
          return;
        }
        
        await joinRoom(roomCode);
      });
      
      // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –∫–æ–º–Ω–∞—Ç—ã
      copyRoomCodeBtnEl.addEventListener("click", () => {
        copyToClipboard(currentRoomCode);
        showNotification("–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω", "success");
      });
      
      // –í—ã—Ö–æ–¥ –∏–∑ –∫–æ–º–Ω–∞—Ç–∞
      leaveRoomBtnEl.addEventListener("click", () => {
        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã?")) {
          leaveRoom();
        }
      });
      
      // –í–µ–¥—É—â–∏–π: –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏–∑ —Ñ–∞–π–ª–æ–≤
      prepareBtnEl.addEventListener("click", () => {
        files = Array.from(fileInputEl.files || []);
        if (!files.length) {
          showNotification("–í—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã.", "warning");
          return;
        }
        songs = files.map((f, i) => `${i + 1}. ${stripExt(f.name)}`);
        songsOutputEl.value = songs.join("\n");
        updateStats();
        showNotification(`–°–ø–∏—Å–æ–∫ –∏–∑ ${songs.length} –ø–µ—Å–µ–Ω —Å–æ–∑–¥–∞–Ω`, "success");
        vibrate(100);
      });
      
      // –í–µ–¥—É—â–∏–π: –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤ –∫–æ–º–Ω–∞—Ç—É
      uploadBtnEl.addEventListener("click", async () => {
        if (!songs.length) {
          showNotification("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Å–ø–∏—Å–æ–∫", "warning");
          return;
        }
        
        if (!currentRoomCode) {
          showNotification("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ", "warning");
          return;
        }
        
        showNotification("–ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Å–µ–Ω –≤ –∫–æ–º–Ω–∞—Ç—É...", "info");
        try {
          const res = await fetch(`${SERVER_URL}/api/rooms/${currentRoomCode}/songs`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(songs)
          });
          
          if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏");
          
          showNotification("–ü–µ—Å–Ω–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ –∫–æ–º–Ω–∞—Ç—É!", "success");
          vibrate(200);
          await updateRoomInfo();
        } catch (e) {
          console.error(e);
          showNotification("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫", "error");
        }
      });
      
      // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
      playBtnEl.addEventListener("click", () => {
        if (!files.length) {
          showNotification("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã", "warning");
          return;
        }
        const num = parseInt(songNumberEl.value, 10);
        
        if (!Number.isInteger(num) || num < 1 || num > files.length) {
          showNotification("–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –ø–µ—Å–Ω–∏", "warning");
          return;
        }
        
        if (playedNumbers.includes(num)) {
          showNotification("–≠—Ç–∞ –ø–µ—Å–Ω—è —É–∂–µ –ø—Ä–æ–∏–≥—Ä–∞–Ω–∞", "info");
          return;
        }
        
        currentSongIndex = num - 1;
        playCurrentSong();
      });
      
      // –û—á–∏—Å—Ç–∫–∞ —Å—ã–≥—Ä–∞–Ω–Ω—ã—Ö
      clearPlayedBtnEl.addEventListener("click", () => {
        if (confirm("–û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å—ã–≥—Ä–∞–Ω–Ω—ã—Ö –ø–µ—Å–µ–Ω?")) {
          playedNumbers = [];
          renderPlayedBarrels();
          syncPlayedNumbers();
          showNotification("–°–ø–∏—Å–æ–∫ –æ—á–∏—â–µ–Ω", "info");
        }
      });
      
      // –í–µ–¥—É—â–∏–π: —Å–æ–∑–¥–∞—Ç—å –±–∏–ª–µ—Ç
      hostTicketBtnEl.addEventListener("click", async () => {
        if (ticketCreated) {
          showNotification("–ë–∏–ª–µ—Ç —É–∂–µ —Å–æ–∑–¥–∞–Ω", "info");
          return;
        }
        
        const list = await getSongsFromRoom();
        if (!list.length) {
          showNotification("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø–µ—Å–Ω–∏ –≤ –∫–æ–º–Ω–∞—Ç—É", "warning");
          return;
        }
        
        const unique = Array.from(new Set(list));
        const selected = shuffle(unique).slice(0, 15);
        renderTicket(selected, hostTicketGridEl);
        ticketCreated = true;
        updateStats();
        showNotification("–ë–∏–ª–µ—Ç —Å–æ–∑–¥–∞–Ω!", "success");
        vibrate(150);
      });
      
      resetTicketBtnEl.addEventListener("click", () => {
        ticketCreated = false;
        hostTicketGridEl.innerHTML = "";
        showNotification("–ë–∏–ª–µ—Ç —Å–±—Ä–æ—à–µ–Ω", "info");
      });
      
      autoMarkBtnEl.addEventListener("click", () => {
        const cells = hostTicketGridEl.querySelectorAll('.cell');
        cells.forEach(cell => {
          const cellText = cell.textContent;
          const match = cellText.match(/^(\d+)\./);
          if (match) {
            const num = parseInt(match[1], 10);
            if (playedNumbers.includes(num)) {
              cell.classList.add('crossed');
            }
          }
        });
        showNotification("–ê–≤—Ç–æ-–æ—Ç–º–µ—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞", "success");
      });
      
      // –ò–≥—Ä–æ–∫: —Å–æ–∑–¥–∞—Ç—å –±–∏–ª–µ—Ç
      getTicketBtnEl.addEventListener("click", async () => {
        if (ticketCreated) {
          showNotification("–ë–∏–ª–µ—Ç —É–∂–µ —Å–æ–∑–¥–∞–Ω", "info");
          return;
        }
        
        const list = await getSongsFromRoom();
        if (!list.length) {
          showNotification("–í–µ–¥—É—â–∏–π –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª —Å–ø–∏—Å–æ–∫", "warning");
          return;
        }
        
        const unique = Array.from(new Set(list));
        const selected = shuffle(unique).slice(0, 15);
        renderTicket(selected, ticketGridEl, true);
        ticketCreated = true;
        showNotification("–í–∞—à –±–∏–ª–µ—Ç –≥–æ—Ç–æ–≤!", "success");
        vibrate(150);
      });
    }
    
    // ============================
    // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ö–û–ú–ù–ê–¢–ê–ú–ò
    // ============================
    
    async function createRoom() {
      try {
        showNotification("–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã...", "info");
        
        const response = await fetch(`${SERVER_URL}/api/rooms/create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            roomCode: generateRoomCode(),
            hostName: hostName
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          currentRoomCode = data.roomCode;
          isHost = true;
          showRoomInfo();
          showNotification(`–ö–æ–º–Ω–∞—Ç–∞ "${currentRoomCode}" —Å–æ–∑–¥–∞–Ω–∞!`, 'success');
          startRoomSync();
        } else {
          showNotification(data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã', 'error');
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã:', error);
        showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
      }
    }
    
    async function joinRoom(roomCode) {
      try {
        showNotification("–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ...", "info");
        
        const response = await fetch(`${SERVER_URL}/api/rooms/${roomCode}/join`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ playerName: playerName })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          currentRoomCode = roomCode;
          isHost = false;
          showRoomInfo();
          showNotification(`–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ "${roomCode}"`, 'success');
          startRoomSync();
        } else {
          showNotification(data.error || '–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ:', error);
        showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
      }
    }
    
    function showRoomInfo() {
      roomCodeDisplayEl.textContent = currentRoomCode;
      hostRoomSectionEl.classList.add("hidden");
      playerRoomSectionEl.classList.add("hidden");
      currentRoomInfoEl.classList.remove("hidden");
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–Ω–∞—Ç–µ
      updateRoomInfo();
    }
    
    async function updateRoomInfo() {
      if (!currentRoomCode) return;
      
      try {
        const response = await fetch(`${SERVER_URL}/api/rooms/${currentRoomCode}/info`);
        if (response.ok) {
          const roomInfo = await response.json();
          
          songsCountDisplayEl.textContent = roomInfo.songsCount;
          playedCountDisplayEl.textContent = roomInfo.playedCount;
          playersCountDisplayEl.textContent = roomInfo.playersCount;
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
          updatePlayersList(roomInfo.hostName, roomInfo.playersCount);
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ —Å–µ–∫—Ü–∏—è—Ö –≤–µ–¥—É—â–µ–≥–æ/–∏–≥—Ä–æ–∫–∞
          if (isHost) {
            hostRoomCodeEl.textContent = currentRoomCode;
            hostSongsCountEl.textContent = roomInfo.songsCount;
            hostPlayersCountEl.textContent = roomInfo.playersCount;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤–µ–¥—É—â–µ–≥–æ
            document.getElementById('hostTitle').textContent = `–í–µ–¥—É—â–∏–π - ${hostName || '–ê–Ω–æ–Ω–∏–º'}`;
          } else {
            playerRoomCodeEl.textContent = currentRoomCode;
            playerSongsCountEl.textContent = roomInfo.songsCount;
            playerPlayedCountEl.textContent = roomInfo.playedCount;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏–≥—Ä–æ–∫–∞
            document.getElementById('playerTitle').textContent = `–ò–≥—Ä–æ–∫ - ${playerName || '–ê–Ω–æ–Ω–∏–º'}`;
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å—ã–≥—Ä–∞–Ω–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –¥–ª—è –∏–≥—Ä–æ–∫–∞
            await syncPlayerPlayedNumbers();
          }
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–º–Ω–∞—Ç–µ:', error);
      }
    }
    
    function updatePlayersList(hostName, playersCount) {
      const playersList = document.getElementById('playersList');
      playersList.innerHTML = `<div class="player-badge host">üëë ${hostName || '–í–µ–¥—É—â–∏–π'}</div>`;
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å)
      for (let i = 2; i <= playersCount; i++) {
        const player = document.createElement('div');
        player.className = 'player-badge';
        player.textContent = `üë§ –ò–≥—Ä–æ–∫ ${i}`;
        playersList.appendChild(player);
      }
    }
    
    function startRoomSync() {
      // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
      if (roomSyncInterval) clearInterval(roomSyncInterval);
      
      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
      roomSyncInterval = setInterval(async () => {
        if (!currentRoomCode) return;
        
        // –î–ª—è –∏–≥—Ä–æ–∫–æ–≤: –ø–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å—ã–≥—Ä–∞–Ω–Ω—ã–µ –Ω–æ–º–µ—Ä–∞
        if (!isHost) {
          await syncPlayerPlayedNumbers();
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–Ω–∞—Ç–µ
        await updateRoomInfo();
      }, 3000);
    }
    
    function leaveRoom() {
      currentRoomCode = null;
      isHost = false;
      if (roomSyncInterval) {
        clearInterval(roomSyncInterval);
        roomSyncInterval = null;
      }
      
      currentRoomInfoEl.classList.add("hidden");
      hostRoomSectionEl.classList.remove("hidden");
      playerRoomSectionEl.classList.remove("hidden");
      
      // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
      hostNameInputEl.value = '';
      playerNameInputEl.value = '';
      roomCodeInputEl.value = '';
      
      showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã', 'info');
    }
    
    function startGame() {
      if (!currentRoomCode) {
        showNotification("–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ", "warning");
        return;
      }
      
      roomSectionEl.classList.add("hidden");
      
      if (isHost) {
        hostSectionEl.classList.remove("hidden");
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤–µ–¥—É—â–µ–≥–æ
        document.getElementById('hostTitle').textContent = `–í–µ–¥—É—â–∏–π - ${hostName || '–ê–Ω–æ–Ω–∏–º'}`;
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Å–Ω–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã
        loadSongsFromRoom();
      } else {
        playerSectionEl.classList.remove("hidden");
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏–≥—Ä–æ–∫–∞
        document.getElementById('playerTitle').textContent = `–ò–≥—Ä–æ–∫ - ${playerName || '–ê–Ω–æ–Ω–∏–º'}`;
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—ã–≥—Ä–∞–Ω–Ω—ã–µ –Ω–æ–º–µ—Ä–∞
        syncPlayerPlayedNumbers();
      }
    }
    
    // ============================
    // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ü–ï–°–ù–Ø–ú–ò
    // ============================
    
    async function loadSongsFromRoom() {
      if (!currentRoomCode) return;
      
      try {
        const roomSongs = await getSongsFromRoom();
        if (roomSongs.length > 0) {
          songs = roomSongs;
          songsOutputEl.value = songs.join("\n");
          
          // –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
          files = songs.map((song, i) => {
            return {
              name: song.replace(/^\d+\.\s*/, '') + '.mp3',
              lastModified: Date.now() + i
            };
          });
          
          showNotification(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${songs.length} –ø–µ—Å–µ–Ω –∏–∑ –∫–æ–º–Ω–∞—Ç—ã`, "success");
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Å–µ–Ω –∏–∑ –∫–æ–º–Ω–∞—Ç—ã:', error);
      }
    }
    
    async function getSongsFromRoom() {
      if (!currentRoomCode) return [];
      
      try {
        const response = await fetch(`${SERVER_URL}/api/rooms/${currentRoomCode}/songs`);
        if (response.ok) {
          return await response.json();
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Å–µ–Ω:', error);
      }
      return [];
    }
    
    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —Ç–µ–∫—É—â—É—é –ø–µ—Å–Ω—é
    function playCurrentSong() {
      const num = currentSongIndex + 1;
      const file = files[currentSongIndex];
      
      if (!file) {
        showNotification("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω", "error");
        return;
      }
      
      const title = songs[currentSongIndex] || `${num}. ${stripExt(file.name)}`;
      currentTitleEl.textContent = title;
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –∏–∑ input
      if (fileInputEl.files && fileInputEl.files[currentSongIndex]) {
        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª
        const realFile = fileInputEl.files[currentSongIndex];
        playerEl.src = URL.createObjectURL(realFile);
      } else {
        // –ï—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        showNotification("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è", "warning");
        return;
      }
      
      playerEl.play().catch(e => {
        showNotification("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: " + e.message, "error");
      });
      
      if (!playedNumbers.includes(num)) {
        playedNumbers.push(num);
        playedNumbers.sort((a, b) => a - b);
        renderPlayedBarrels();
        showNotification(`–ò–≥—Ä–∞–µ—Ç: ${title}`, "success");
        vibrate(100);
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å —Å–µ—Ä–≤–µ—Ä–æ–º (–µ—Å–ª–∏ –≤–µ–¥—É—â–∏–π)
        if (isHost) {
          syncPlayedNumbers();
        }
      }
      
      updatePlayerStats();
    }
    
    // ============================
    // –§–£–ù–ö–¶–ò–ò –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò
    // ============================
    
    async function syncPlayedNumbers() {
      if (!currentRoomCode || !isHost) return;
      
      try {
        await fetch(`${SERVER_URL}/api/rooms/${currentRoomCode}/played`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(playedNumbers)
        });
        // –£–±—Ä–∞–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å—ã–≥—Ä–∞–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤:', error);
      }
    }
    
    async function syncPlayerPlayedNumbers() {
      if (!currentRoomCode || isHost) return;
      
      try {
        const response = await fetch(`${SERVER_URL}/api/rooms/${currentRoomCode}/played`);
        if (response.ok) {
          const serverPlayedNumbers = await response.json();
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫, –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
          if (JSON.stringify(serverPlayedNumbers) !== JSON.stringify(playedNumbers)) {
            playedNumbers = serverPlayedNumbers;
            renderPlayedBarrels();
          }
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—ã–≥—Ä–∞–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤:', error);
      }
    }
    
    function syncRoomData() {
      updateRoomInfo();
      showNotification("–î–∞–Ω–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã", "info");
    }
    
    // ============================
    // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
    // ============================
    
    function stripExt(name) {
      return name.replace(/\.[^/.]+$/, "");
    }
    
    function generateRoomCode() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let result = '';
      for (let i = 0; i < 6; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }
    
    function shuffle(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }
    
    function renderPlayedBarrels() {
      playedBarrelsEl.innerHTML = "";
      playedNumbers.forEach(n => {
        playedBarrelsEl.appendChild(makeBarrel(n));
      });
      updatePlayerStats();
    }
    
    function makeBarrel(num) {
      const barrel = document.createElement("div");
      barrel.className = "barrel";
      barrel.textContent = num;
      barrel.addEventListener('click', () => {
        songNumberEl.value = num;
        if (files.length >= num) {
          currentSongIndex = num - 1;
          playCurrentSong();
        }
      });
      return barrel;
    }
    
    function renderTicket(names, gridEl, isPlayer = false) {
      gridEl.innerHTML = "";
      names.forEach((name, index) => {
        const cell = document.createElement("div");
        cell.className = "cell";
        
        // –£–±–∏—Ä–∞–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é "1. ", "2. " –∏ —Ç.–¥.
        const cleanName = name.replace(/^\d+\.\s*/, '');
        const displayName = cleanName.length > 50 ? cleanName.substring(0, 47) + '...' : cleanName;
        
        cell.textContent = displayName;
        cell.title = cleanName;
        
        cell.dataset.index = index;
        cell.dataset.fullName = cleanName;
        cell.dataset.originalName = name; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª —Å –Ω–æ–º–µ—Ä–æ–º
        
        if (cleanName.length > 30) {
          cell.classList.add("long-text");
        }
        
        cell.addEventListener("click", () => {
          cell.classList.toggle("crossed");
          if (isPlayer) updatePlayerStats();
          vibrate(30);
        });
        
        gridEl.appendChild(cell);
      });
      
      if (isPlayer) updatePlayerStats();
    }
    
    function updatePlayerStats() {
      if (ticketGridEl && ticketCreated) {
        const crossed = ticketGridEl.querySelectorAll('.cell.crossed').length;
        const remaining = 15 - crossed;
        
        document.getElementById('markedCount').textContent = crossed;
        document.getElementById('remainingCount').textContent = remaining;
      }
    }
    
    function updateStats() {
      document.getElementById('totalSongs').textContent = songs.length;
      document.getElementById('totalGames').textContent = ticketCreated ? 1 : 0;
    }
    
    function goBackToRoleSelect() {
      leaveRoom();
      roomSectionEl.classList.add("hidden");
      roleSelectEl.classList.remove("hidden");
      vibrate(50);
    }
    
    function goBackToRoom() {
      if (isHost) {
        hostSectionEl.classList.add("hidden");
      } else {
        playerSectionEl.classList.add("hidden");
      }
      roomSectionEl.classList.remove("hidden");
      vibrate(50);
    }
    
    function toggleCollapsible(id) {
      const element = document.getElementById(id);
      const arrow = document.getElementById(id.replace('Section', 'Arrow'));
      
      element.classList.toggle('hidden');
      arrow.textContent = element.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
    }
    
    function showNotification(message, type = "info") {
      const notification = document.createElement("div");
      notification.className = `notification ${type}`;
      notification.textContent = message;
      
      const area = document.getElementById("notificationArea");
      area.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }
    
    function vibrate(pattern) {
      if (navigator.vibrate) {
        navigator.vibrate(pattern);
      }
    }
    
    function shareTicket() {
      if (navigator.share) {
        navigator.share({
          title: '–ú–æ–π –±–∏–ª–µ—Ç –ú—É–∑—ã–∫–∞–ª—å–Ω–æ–≥–æ –õ–æ—Ç–æ',
          text: `–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –∏–≥—Ä–µ! –ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã: ${currentRoomCode || '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}`,
          url: window.location.href
        });
      } else {
        const text = `–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –∏–≥—Ä–µ –≤ –ú—É–∑—ã–∫–∞–ª—å–Ω–æ–µ –õ–æ—Ç–æ! –ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã: ${currentRoomCode || '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}\n–°—Å—ã–ª–∫–∞: ${window.location.href}`;
        copyToClipboard(text);
        showNotification("–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞", "success");
      }
    }
    
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).catch(() => {
        // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand("copy");
        document.body.removeChild(textArea);
      });
    }
  </script>
</body>
</html>



